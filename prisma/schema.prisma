generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  DEALER
  ADMIN
}

enum DealType {
  SALE
  RENT
}

enum FuelType {
  GASOLINE
  DIESEL
  HYBRID
  ELECTRIC
  LPG
  CNG
  OTHER
}

enum Gearbox {
  MANUAL
  AUTOMATIC
  CVT
  AMT
  OTHER
}

enum DriveType {
  FWD
  RWD
  AWD
  OTHER
}

enum BodyType {
  SEDAN
  SUV
  HATCHBACK
  WAGON
  COUPE
  CONVERTIBLE
  VAN
  PICKUP
  OTHER
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  ARCHIVED
  REJECTED
}

enum RegistrationType {
  NOT_CLEARED
  RF
  RSO
}

enum Currency {
  RUB
  USD
  EUR
  GEL
}

model User {
  id           String  @id @default(cuid())
  email        String? @unique
  phone        String? @unique
  name         String?
  role         Role    @default(USER)
  passwordHash String?

  dealer         Dealer?
  listings       Listing[]
  sessions       Session[]
  favorites      Favorite[]
  vinChecks      VinCheck[]
  moderationLogs ModerationLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model Dealer {
  id          String @id @default(cuid())
  ownerUserId String @unique
  owner       User   @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)

  name        String
  slug        String  @unique
  logoUrl     String?
  description String?
  phone       String?
  city        String?
  address     String?
  isVerified  Boolean @default(false)

  listings Listing[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Make {
  id   String @id @default(cuid())
  name String
  slug String @unique

  models   Model[]
  listings Listing[]
}

model Model {
  id     String @id @default(cuid())
  makeId String
  make   Make   @relation(fields: [makeId], references: [id], onDelete: Cascade)

  name String
  slug String

  listings Listing[]

  @@unique([makeId, slug])
}

model Listing {
  id   String @id @default(cuid())
  slug String @unique

  ownerUserId String
  owner       User   @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)

  dealerId String?
  dealer   Dealer? @relation(fields: [dealerId], references: [id], onDelete: SetNull)

  dealType DealType
  status   ListingStatus @default(DRAFT)

  makeId String
  make   Make   @relation(fields: [makeId], references: [id])

  modelId String
  model   Model  @relation(fields: [modelId], references: [id])

  title    String
  year     Int
  price    Int
  currency Currency @default(RUB)
  mileage  Int

  registration RegistrationType?
  city String?

  fuel    FuelType?
  gearbox Gearbox?
  drive   DriveType?
  body    BodyType?
  color   String?

  engineVolume String?
  vin          String?
  description  String?
  phone        String?

  isTop     Boolean @default(false)
  isUrgent  Boolean @default(false)
  isSticker Boolean @default(false)

  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  images         ListingImage[]
  favorites      Favorite[]
  promotions     ListingPromotion[]
  moderationLogs ModerationLog[]

  @@index([status, createdAt])
  @@index([dealType, makeId, modelId])
  @@index([price])
  @@index([year])
  @@index([mileage])
  @@index([city])
}

model ListingImage {
  id        String  @id @default(cuid())
  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  url       String
  publicId  String? @unique
  sortOrder Int     @default(0)
  isCover   Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([listingId, sortOrder])
}

model Favorite {
  id        String @id @default(cuid())
  userId    String
  listingId String

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, listingId])
  @@index([listingId])
}

model PromotionPlan {
  id           String   @id @default(cuid())
  code         String   @unique
  title        String
  type         String // TOP/BUMP/HIGHLIGHT
  price        Int
  currency     Currency @default(RUB)
  durationDays Int?
  bumpsCount   Int?

  promotions ListingPromotion[]
}

model ListingPromotion {
  id        String @id @default(cuid())
  listingId String
  planId    String

  listing Listing       @relation(fields: [listingId], references: [id], onDelete: Cascade)
  plan    PromotionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)

  startsAt  DateTime  @default(now())
  endsAt    DateTime?
  bumpsLeft Int?

  @@index([listingId])
  @@index([endsAt])
}

model VinCheck {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  vin         String
  status      String @default("OK")
  rawResponse Json?

  createdAt DateTime @default(now())

  @@index([vin])
  @@index([userId, createdAt])
}

model ModerationLog {
  id        String @id @default(cuid())
  listingId String
  adminId   String

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  admin   User    @relation(fields: [adminId], references: [id], onDelete: Restrict)

  action String // APPROVE/REJECT
  reason String?

  createdAt DateTime @default(now())

  @@index([listingId, createdAt])
}
